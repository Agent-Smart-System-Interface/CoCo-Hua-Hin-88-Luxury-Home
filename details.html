<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>smart properties system ¬∑ details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Kanit,sans-serif}
    .glass{
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.28);
      backdrop-filter: blur(10px);
    }
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.75);
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      font-weight:900;font-size:12px;
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      backdrop-filter: blur(6px);
      max-width: 100%;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .mini{
      display:grid;place-items:center;
      border-radius: 20px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 14px;
      text-align:center;
    }
    .mini .k{font-size:11px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#94a3b8}
    .mini .v{font-size:18px;font-weight:900;color:#0f172a;margin-top:6px}
    .btn{
      border-radius: 18px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      padding: 12px 14px;
    }
    .btn:active{transform:scale(.98)}
  </style>
</head>

<body class="min-h-screen bg-slate-900 italic">
  <div class="max-w-5xl mx-auto p-4 md:p-10">
    <!-- Header -->
    <div class="rounded-[2.5rem] p-6 sm:p-8 md:p-10 text-white shadow-2xl glass">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <p class="text-white/80 font-extrabold uppercase tracking-[0.25em] text-xs">Property Detail</p>
          <h1 id="hpTitle" class="text-3xl sm:text-4xl font-extrabold tracking-tight mt-2 truncate">HP-XXXX</h1>
          <div class="flex flex-wrap gap-2 mt-3">
            <span id="badgeSys" class="badge bg-white/80 text-slate-900">System: -</span>
            <span id="badgeStatus" class="badge bg-white/80 text-slate-900">Status: -</span>
          </div>
        </div>

        <div class="flex gap-2">
          <a id="btnBack" class="btn bg-white/10 hover:bg-white/20 text-white" href="index.html">Back</a>
          <a id="btnEdit" class="btn bg-emerald-600 hover:bg-emerald-500 text-white hidden" href="#">Edit</a>
        </div>
      </div>
    </div>

    <!-- Not available -->
    <div id="notAvailable" class="hidden mt-6 card rounded-[2rem] p-8 text-center">
      <div class="text-2xl font-extrabold text-slate-900 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
      <div class="text-slate-500 font-bold text-sm">System Status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Live</div>
      <div class="mt-4 flex justify-center gap-2">
        <a class="btn bg-slate-900 hover:bg-blue-600 text-white" href="index.html">Go Index</a>
        <a id="btnGoGateway" class="btn bg-white text-slate-900 border border-slate-200" href="gateway.html">Login</a>
      </div>
    </div>

    <!-- Content -->
    <div id="content" class="hidden">
      <!-- Gallery -->
      <div class="mt-6 card rounded-[2rem] overflow-hidden">
        <div class="aspect-[16/10] bg-slate-100" id="coverBox">
          <div class="w-full h-full grid place-items-center text-5xl">üñºÔ∏è</div>
        </div>
        <div class="p-5">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2" id="thumbs"></div>
        </div>
      </div>

      <!-- Quick facts -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="mini">
          <div class="k">Price</div>
          <div class="v" id="vPrice">‡∏ø0</div>
        </div>
        <div class="mini">
          <div class="k">Beds / Baths</div>
          <div class="v"><span id="vBed">-</span> / <span id="vBath">-</span></div>
        </div>
        <div class="mini">
          <div class="k">Living Area</div>
          <div class="v"><span id="vLiving">-</span> m¬≤</div>
        </div>
      </div>

      <!-- Data -->
      <div class="mt-6 card rounded-[2rem] p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <div class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">Plot / Type</div>
            <div class="text-xl font-extrabold text-slate-900 mt-1">
              <span id="vPlot">-</span> ¬∑ <span id="vType">-</span>
            </div>
            <div class="text-slate-500 font-bold text-sm mt-1" id="vProjectName"></div>
            <div class="text-slate-500 font-bold text-sm mt-2" id="vAddress"></div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="mini">
              <div class="k">Land</div>
              <div class="v"><span id="vLandW">-</span> sq.w</div>
              <div class="text-xs font-bold text-slate-400 mt-1"><span id="vLandM">-</span> sq.m</div>
            </div>
            <div class="mini">
              <div class="k">Pool</div>
              <div class="v"><span id="vPoolSize">-</span></div>
              <div class="text-xs font-bold text-slate-400 mt-1"><span id="vPoolDepth">-</span></div>
            </div>
            <div class="mini">
              <div class="k">Furnishing</div>
              <div class="v" id="vFurn">-</div>
            </div>
            <div class="mini">
              <div class="k">Zone</div>
              <div class="v" id="vZone">-</div>
            </div>
          </div>
        </div>

        <div class="mt-5 border-t pt-5">
          <div class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">Description</div>
          <div class="mt-2 text-slate-700 font-medium leading-relaxed whitespace-pre-wrap" id="vDesc">-</div>
        </div>
      </div>

      <!-- Links -->
      <div class="mt-6 card rounded-[2rem] p-6">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">External Links</div>
            <div class="text-xl font-extrabold text-slate-900 mt-1">Open / Download</div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <a id="lnkFB" class="btn bg-blue-600 hover:bg-blue-500 text-white hidden" target="_blank" rel="noopener">FB</a>
            <a id="lnkVT" class="btn bg-purple-600 hover:bg-purple-500 text-white hidden" target="_blank" rel="noopener">Virtual Tour</a>
            <a id="lnkMap" class="btn bg-emerald-600 hover:bg-emerald-500 text-white hidden" target="_blank" rel="noopener">Map</a>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
          <a id="pdfSales" class="btn bg-slate-900 hover:bg-blue-600 text-white hidden" target="_blank" rel="noopener">Sales PDF</a>
          <a id="pdfMat" class="btn bg-slate-900 hover:bg-blue-600 text-white hidden" target="_blank" rel="noopener">Material PDF</a>
          <a id="pdfFloor" class="btn bg-slate-900 hover:bg-blue-600 text-white hidden" target="_blank" rel="noopener">Floor Plan</a>
        </div>

        <div id="mapFrameWrap" class="hidden mt-5 overflow-hidden rounded-[1.75rem] border border-slate-200">
          <iframe id="mapFrame" class="w-full h-[360px]" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************************************************
     * CONFIG (Web App URL ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
     **********************************************************/
    const API_URL = "https://script.google.com/macros/s/AKfycbyTeJrl7A5D6nSjcxBsMAmfT0YcopmjMqI5YuXZ65FOXnWziWwe_j1FocdlaWWlQePR/exec";

    const params = new URLSearchParams(location.search);
    const HP_ID = (params.get("id") || "").trim();
    const PROJECT = (params.get("project") || "HP00").trim();

    const TOKEN = (params.get("token") || localStorage.getItem("HP_AUTH_TOKEN") || "").trim();
    const ROLE  = (localStorage.getItem("HP_AUTH_ROLE") || "").trim();

    const $ = (id)=>document.getElementById(id);

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtPrice(v){
      const n = Number(String(v||"").replace(/,/g,""));
      if (!isFinite(n) || n<=0) return "‡∏ø0";
      return "‡∏ø" + n.toLocaleString("en-US");
    }
    function normSys(v){
      const low = String(v||"").trim().toLowerCase();
      if(low==="live") return "Live";
      if(low==="pending") return "Pending";
      if(low==="offline") return "Offline";
      return String(v||"").trim();
    }
    function isLive(v){ return normSys(v) === "Live"; }

    // JSONP helper
    function jsonp_(paramsObj, timeoutMs = 15000){
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(16).slice(2);
        const urlParams = new URLSearchParams();
        Object.entries(paramsObj||{}).forEach(([k,v])=>{
          if(v===undefined || v===null) return;
          urlParams.set(k, String(v));
        });
        urlParams.set("callback", cbName);
        urlParams.set("t", Date.now());

        const script = document.createElement("script");
        let done = false;

        const timer = setTimeout(()=>{
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP timeout"));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
          if(script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (data)=>{
          if(done) return;
          done = true;
          cleanup();
          resolve(data);
        };

        script.onerror = ()=>{
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP network error"));
        };

        script.src = API_URL + "?" + urlParams.toString();
        document.body.appendChild(script);
      });
    }

    async function getDetail_(){
      try{
        return await jsonp_({ mode:"getUnitDetail", hpId: HP_ID, project: PROJECT, token: TOKEN });
      }catch(_){
        const url = new URL(API_URL);
        url.searchParams.set("mode","getUnitDetail");
        url.searchParams.set("hpId", HP_ID);
        url.searchParams.set("project", PROJECT);
        if(TOKEN) url.searchParams.set("token", TOKEN);
        const res = await fetch(url.toString(), { cache:"no-store" });
        return await res.json();
      }
    }

    function showEl(id, on){ $(id).classList.toggle("hidden", !on); }

    function setBadge(el, label, value){
      el.textContent = `${label}: ${value || "-"}`;
    }

    function setLink(elId, url){
      const el = $(elId);
      const u = String(url||"").trim();
      if(!u){ el.classList.add("hidden"); el.removeAttribute("href"); return; }
      el.classList.remove("hidden");
      el.href = u;
    }

    // Map embed helper: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô maps.app.goo.gl ‡∏à‡∏∞ embed ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ
    // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ embed ‡πÅ‡∏ö‡∏ö query ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á iframe
    function trySetMapEmbed(mapUrl){
      const raw = String(mapUrl||"").trim();
      if(!raw){ showEl("mapFrameWrap", false); return; }

      // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô google.com/maps ‡∏´‡∏£‡∏∑‡∏≠ www.google.com/maps -> ‡πÉ‡∏ä‡πâ embed?pb ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
      // ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏á‡πà‡∏≤‡∏¢: embed ‡πÅ‡∏ö‡∏ö q=
      let embed = "";
      try{
        const u = new URL(raw);
        const host = u.hostname.toLowerCase();
        if(host.includes("google.") && u.pathname.includes("/maps")){
          embed = "https://www.google.com/maps?q=" + encodeURIComponent(raw) + "&output=embed";
        } else if(host.includes("maps.app.goo.gl")){
          // short link embed ‡∏¢‡∏≤‡∏Å -> ‡πÉ‡∏ä‡πâ q= link ‡πÅ‡∏ó‡∏ô
          embed = "https://www.google.com/maps?q=" + encodeURIComponent(raw) + "&output=embed";
        } else {
          embed = "https://www.google.com/maps?q=" + encodeURIComponent(raw) + "&output=embed";
        }
      }catch(_){
        embed = "https://www.google.com/maps?q=" + encodeURIComponent(raw) + "&output=embed";
      }

      $("mapFrame").src = embed;
      showEl("mapFrameWrap", true);
    }

    function renderGallery(thumb, listStr){
      const coverBox = $("coverBox");
      const thumbs = $("thumbs");
      thumbs.innerHTML = "";

      const urls = [];
      const t = String(thumb||"").trim();
      if(t) urls.push(t);

      if(listStr){
        String(listStr).split(",").map(s=>s.trim()).filter(Boolean).forEach(u=>{
          if(!urls.includes(u)) urls.push(u);
        });
      }

      // cover
      if(urls.length){
        coverBox.innerHTML = `<img src="${esc(urls[0])}" class="w-full h-full object-cover" referrerpolicy="no-referrer">`;
      } else {
        coverBox.innerHTML = `<div class="w-full h-full grid place-items-center text-5xl">üñºÔ∏è</div>`;
      }

      // thumbs
      urls.slice(0, 12).forEach(u=>{
        const a = document.createElement("button");
        a.className = "aspect-square rounded-2xl overflow-hidden border border-slate-200 bg-slate-100";
        a.innerHTML = `<img src="${esc(u)}" class="w-full h-full object-cover" referrerpolicy="no-referrer">`;
        a.addEventListener("click", ()=>{
          coverBox.innerHTML = `<img src="${esc(u)}" class="w-full h-full object-cover" referrerpolicy="no-referrer">`;
          window.scrollTo({ top:0, behavior:"smooth" });
        });
        thumbs.appendChild(a);
      });
    }

    async function init(){
      $("btnBack").href = `index.html?project=${encodeURIComponent(PROJECT)}`;
      $("btnGoGateway").href = `gateway.html?project=${encodeURIComponent(PROJECT)}`;
      $("hpTitle").textContent = HP_ID || "HP-XXXX";

      if(!HP_ID){
        showEl("notAvailable", true);
        $("notAvailable").querySelector(".text-2xl").textContent = "Missing id";
        return;
      }

      try{
        const data = await getDetail_();
        if(data && data.error) throw new Error(data.error);

        const sys = normSys(data.System_Status || data.system_status || data.sysStatus || "");
        const status = String(data.Status || data.status || "").trim();

        setBadge($("badgeSys"), "System", sys || "-");
        setBadge($("badgeStatus"), "Status", status || "-");

        // rule: public view only Live
        const live = isLive(sys);
        const allowPreview = live || (!!TOKEN); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ token ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÑ‡∏î‡πâ (admin preview)
        if(!allowPreview){
          showEl("notAvailable", true);
          showEl("content", false);
          return;
        }

        // show content
        showEl("notAvailable", false);
        showEl("content", true);

        // edit button for admin
        if(TOKEN){
          const editHref = `edit.html?id=${encodeURIComponent(HP_ID)}&project=${encodeURIComponent(PROJECT)}&token=${encodeURIComponent(TOKEN)}`;
          $("btnEdit").href = editHref;
          $("btnEdit").classList.remove("hidden");
        }

        // fill
        $("vPrice").textContent = fmtPrice(data.Price || data.price || "");
        $("vBed").textContent = (data.Bedrooms ?? data.bedrooms ?? "-");
        $("vBath").textContent = (data.Bathrooms ?? data.bathrooms ?? "-");
        $("vLiving").textContent = (data.Living_Area_sq_m ?? data.livingSqm ?? data.living_area_sq_m ?? "-");

        $("vPlot").textContent = (data.Plot ?? data.plot ?? "-");
        $("vType").textContent = (data.Type ?? data.type ?? "-");
        $("vProjectName").textContent = String(data.Project_Name ?? data.projectName ?? data.project_name ?? "").trim();
        $("vAddress").textContent = String(data.Address ?? data.address ?? "").trim();

        $("vLandW").textContent = (data.Land_Area_sq_w ?? data["Land Area (sq.w)"] ?? "-");
        $("vLandM").textContent = (data.Land_Area_sq_m ?? data["Land Area (sq.m)"] ?? "-");
        $("vPoolSize").textContent = (data.Pool_Size ?? data["Pool Size"] ?? "-");
        $("vPoolDepth").textContent = (data.Pool_Depth ?? data["Pool Depth"] ?? "-");
        $("vFurn").textContent = String(data.Furnishing ?? "").trim() || "-";
        $("vZone").textContent = String(data.Zone ?? "").trim() || "-";
        $("vDesc").textContent = String(data.Description ?? data.description ?? "").trim() || "-";

        // links
        setLink("lnkFB",  data.FB_Link || data.fb || "");
        setLink("lnkVT",  data.Virtual_Tour || data.virtual_tour || "");
        setLink("lnkMap", data.Map_Link || data.map || "");

        setLink("pdfSales", data.Sales_Gallery || data.sales_gallery || "");
        setLink("pdfMat",   data.Material_PDF || data.material_pdf || "");
        setLink("pdfFloor", data.FloorPlan_PDF || data.floorplan_pdf || "");

        // embed map (optional)
        trySetMapEmbed(data.Map_Link || "");

        // gallery
        renderGallery(data.Thumbnail_Image || data.thumbnail || "", data.Image_List || data.image_list || "");
      }catch(e){
        console.error(e);
        showEl("notAvailable", true);
        $("notAvailable").querySelector(".text-2xl").textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        $("notAvailable").querySelector(".text-slate-500").textContent = e.message || "error";
      }
    }

    init();
  </script>
</body>
</html>
