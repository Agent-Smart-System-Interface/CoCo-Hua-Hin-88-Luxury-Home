<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>smart properties system · details</title>
  <style>
    :root{
      --bg:#0b1320;
      --card:#ffffff;
      --text:#0b1320;
      --muted:#6b7a90;
      --shadow:0 18px 46px rgba(0,0,0,.22);
      --radius:26px;
      --line:rgba(255,255,255,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai",sans-serif;
      min-height:100vh;
      background: radial-gradient(900px 520px at 10% 10%, rgba(255,255,255,.10), transparent 55%),
                  radial-gradient(900px 520px at 90% 20%, rgba(255,255,255,.08), transparent 55%),
                  linear-gradient(180deg, #0a1426, #071022 60%, #050b16);
      color:#eaf0ff;
      padding: 22px 12px 48px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .hero{
      background: rgba(255,255,255,.10);
      border:1px solid var(--line);
      border-radius: 34px;
      padding: 26px 22px;
      backdrop-filter: blur(10px);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .kicker{letter-spacing:2px;font-weight:800;font-size:12px;opacity:.85}
    .title{
      margin:8px 0 0;
      font-size:44px;
      font-weight:1000;
      letter-spacing:1px;
      line-height:1.05;
    }
    .chips{margin-top:14px; display:flex; gap:10px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.20);
      font-weight:900;
      font-size:13px;
      color:#f1f5ff;
      white-space:nowrap;
    }
    .btnBack{
      border:none;
      cursor:pointer;
      padding:12px 16px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.20);
      color:#fff;
      font-weight:900;
    }
    .btnBack:active{transform:scale(.99)}
    .panel{
      margin-top:18px;
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(255,255,255,.75);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      color: var(--text);
      overflow:hidden;
    }
    .panelHead{
      padding: 18px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(11,19,32,.10);
    }
    .panelTitle{
      font-weight:1000;
      font-size:18px;
    }
    .small{
      font-size:12px;
      color: rgba(11,19,32,.65);
      font-weight:800;
    }
    .content{padding: 16px 18px 20px}
    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .grid{grid-template-columns: 1.2fr .8fr;}
    }
    .card{
      background:#fff;
      border:1px solid rgba(11,19,32,.10);
      border-radius: 18px;
      padding:14px;
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 0;
      border-bottom:1px dashed rgba(11,19,32,.10);
    }
    .row:last-child{border-bottom:none}
    .lbl{font-weight:900;color:rgba(11,19,32,.70)}
    .val{font-weight:1000}
    .imgWrap{
      aspect-ratio: 16/10;
      background:#eef3f8;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(11,19,32,.08);
    }
    .imgWrap img{width:100%;height:100%;object-fit:cover;display:block}
    .errorBox{
      margin-top:18px;
      background: rgba(255,255,255,.94);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.75);
      box-shadow: var(--shadow);
      color:#0b1320;
      padding: 18px;
      text-align:center;
      font-weight:1000;
    }
    .errorSub{
      margin-top:6px;
      font-weight:900;
      color: rgba(11,19,32,.70);
      font-size:13px;
    }
    .actions{margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
    .aBtn{
      border:none; cursor:pointer;
      padding:12px 16px;
      border-radius: 999px;
      font-weight:1000;
    }
    .aBtn.primary{background:#0b1320;color:#fff}
    .aBtn.ghost{background:rgba(11,19,32,.08);color:#0b1320}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <div class="kicker">PROPERTY DETAIL</div>
        <div class="title" id="hpTitle">—</div>
        <div class="chips">
          <div class="chip" id="sysChip">System: —</div>
          <div class="chip" id="statusChip">Status: —</div>
          <div class="chip" id="pjChip">PJ: —</div>
        </div>
      </div>
      <button class="btnBack" id="backBtn">BACK</button>
    </div>

    <div id="mainPanel" class="panel" style="display:none;">
      <div class="panelHead">
        <div>
          <div class="panelTitle">รายละเอียดทรัพย์</div>
          <div class="small" id="subInfo">—</div>
        </div>
        <div class="small" id="priceInfo">—</div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="card">
            <div class="imgWrap">
              <img id="coverImg" alt="cover" referrerpolicy="no-referrer" />
            </div>
          </div>

          <div class="card" id="kvBox"></div>
        </div>
      </div>
    </div>

    <div id="errPanel" class="errorBox" style="display:none;">
      โหลดข้อมูลไม่สำเร็จ
      <div class="errorSub" id="errMsg">—</div>
      <div class="actions">
        <button class="aBtn primary" id="goIndexBtn">GO INDEX</button>
        <button class="aBtn ghost" id="goLoginBtn">LOGIN</button>
      </div>
    </div>
  </div>

  <script>
    /**********************************************************
     * CONFIG
     **********************************************************/
    const API_URL = "https://script.google.com/macros/s/AKfycbyg8elBgyIJaXG3vCrovI_dVB_JPgo0elSSa0HsCiFg8abSheSzAGmP8bY3ptaLZaEu/exec";

    const qs = new URLSearchParams(location.search);
    const PROJECT = (qs.get("project") || "properties").trim();
    const HPID = (qs.get("hpId") || qs.get("id") || "").trim();

    // ✅ สำคัญ: โหมดดูทั่วไปห้ามส่ง token
    // ถ้าต้องการดูแบบแอดมินค่อยเปิดด้วย &admin=1
    const ADMIN_MODE = String(qs.get("admin") || "") === "1";

    const TOKEN_KEY = "SP_TOKEN"; // ถ้า gateway ของคุณใช้ key คนละชื่อ เปลี่ยนตรงนี้ให้ตรง
    const ROLE_KEY  = "SP_ROLE";

    const gatewayUrl = `gateway.html?project=${encodeURIComponent(PROJECT)}`;
    const indexUrl = `index.html?project=${encodeURIComponent(PROJECT)}`;

    const el = (id)=>document.getElementById(id);

    el("pjChip").textContent = `PJ: ${PROJECT}`;
    el("hpTitle").textContent = HPID || "—";

    el("backBtn").addEventListener("click", ()=>{
      // กลับ index ของโปรเจคเดียวกัน
      location.href = indexUrl;
    });

    el("goIndexBtn").addEventListener("click", ()=> location.href = indexUrl);
    el("goLoginBtn").addEventListener("click", ()=>{
      // ส่ง returnTo กลับมาหน้านี้
      const returnTo = encodeURIComponent(location.pathname + location.search);
      location.href = gatewayUrl + `&returnTo=${returnTo}`;
    });

    function jsonp_(paramsObj, timeoutMs = 15000){
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(16).slice(2);
        const q = new URLSearchParams();
        Object.entries(paramsObj || {}).forEach(([k,v])=>{
          if(v===undefined || v===null || v==="") return;
          q.set(k, String(v));
        });
        q.set("callback", cbName);
        q.set("t", Date.now());

        const script = document.createElement("script");
        let done = false;

        const timer = setTimeout(() => {
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP timeout"));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
          if(script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (data)=>{
          if(done) return;
          done = true;
          cleanup();
          resolve(data);
        };

        script.onerror = ()=>{
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP network error"));
        };

        script.src = API_URL + "?" + q.toString();
        document.body.appendChild(script);
      });
    }

    function setError(msg){
      el("mainPanel").style.display = "none";
      el("errPanel").style.display = "block";
      el("errMsg").textContent = msg || "—";
    }

    function fmtPrice(v){
      const n = Number(String(v||"").replace(/,/g,""));
      if (!isFinite(n) || n<=0) return "฿0";
      return "฿" + n.toLocaleString("en-US");
    }

    function safeText(v){ return String(v==null ? "" : v).trim(); }

    function buildKV(obj){
      const keys = [
        ["Plot","Plot"],
        ["Type","Type"],
        ["Bedrooms","Bedrooms"],
        ["Bathrooms","Bathrooms"],
        ["Living_Area_sq_m","Living Area (sq.m)"],
        ["Land_Area_sq_w","Land Area (sq.w)"],
        ["Price","Price"],
        ["District","District"],
        ["SubDistrict","SubDistrict"],
        ["Zone","Zone"]
      ];

      const html = keys.map(([k,label])=>{
        const val = safeText(obj[k]);
        if(!val) return "";
        return `<div class="row"><div class="lbl">${label}</div><div class="val">${val}</div></div>`;
      }).join("");

      el("kvBox").innerHTML = html || `<div class="small">ไม่มีข้อมูล</div>`;
    }

    function applyData(obj){
      const sys = safeText(obj.System_Status || obj["System Status"]);
      const st  = safeText(obj.Status);
      el("sysChip").textContent = `System: ${sys || "-"}`;
      el("statusChip").textContent = `Status: ${st || "-"}`;

      el("subInfo").textContent = safeText(obj.Project_Name || "") || "—";
      el("priceInfo").textContent = fmtPrice(obj.Price || "");

      const cover = safeText(obj.Thumbnail_Image || "");
      if(cover){
        el("coverImg").src = cover;
        el("coverImg").style.display = "block";
      }else{
        el("coverImg").style.display = "none";
      }

      buildKV(obj);

      el("mainPanel").style.display = "block";
      el("errPanel").style.display = "none";
    }

    function clearBadToken(){
      try{ localStorage.removeItem(TOKEN_KEY); }catch(_){}
      try{ localStorage.removeItem(ROLE_KEY); }catch(_){}
    }

    async function load(){
      if(!HPID){
        setError("Missing hpId / id");
        return;
      }

      // ✅ โหมดทั่วไป: ไม่ส่ง token
      // ✅ โหมดแอดมิน: ส่ง token ถ้ามี
      const token = ADMIN_MODE ? (localStorage.getItem(TOKEN_KEY) || "") : "";

      try{
        const raw = await jsonp_({
          mode: "getUnitDetail",
          project: PROJECT,
          hpId: HPID,
          token: token
        });

        // ถ้า GS ส่ง error มา
        if(raw && raw.error){
          const em = String(raw.error || "");

          // ✅ ถ้า token เสีย/หมดอายุ: ล้าง token แล้ว “ลองโหลดใหม่แบบ public” ทันที
          if(em.toLowerCase().includes("unauthorized") || em.toLowerCase().includes("token")){
            clearBadToken();

            // retry แบบไม่ส่ง token
            const retry = await jsonp_({
              mode: "getUnitDetail",
              project: PROJECT,
              hpId: HPID
            });

            if(retry && retry.error){
              setError(String(retry.error));
              return;
            }

            applyData(retry || {});
            return;
          }

          setError(em);
          return;
        }

        applyData(raw || {});
      }catch(err){
        setError(err.message || String(err));
      }
    }

    load();
  </script>
</body>
</html>
