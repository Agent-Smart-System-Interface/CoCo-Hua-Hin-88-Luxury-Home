<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PROJECT DASHBOARD | SMART PROPERTIES</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Kanit,sans-serif}
    .glass{
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.28);
      backdrop-filter: blur(10px);
    }
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.75);
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      font-weight:900;font-size:12px;
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      backdrop-filter: blur(6px);
      max-width: 100%;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .btn{
      border-radius: 18px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      padding: 12px 14px;
    }
    .btn:active{transform:scale(.98)}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.28);
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(15,23,42,.92);color:#fff;padding:10px 14px;border-radius:999px;
      font-weight:800;font-size:13px;opacity:0;pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;z-index:9999;max-width: 94vw;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px);}
  </style>
</head>

<body class="min-h-screen bg-slate-900 italic">
  <!-- Header -->
  <div class="max-w-6xl mx-auto p-4 md:p-10">
    <div class="rounded-[2.5rem] p-6 sm:p-8 md:p-10 text-white shadow-2xl glass">
      <div class="flex flex-col md:flex-row md:items-center gap-6">
        <div class="flex-1 min-w-0">
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <span class="chip">üîí Admin Dashboard</span>
            <span class="chip" id="chipRole">ROLE: -</span>
            <span class="chip" id="chipProject">PROJECT: -</span>
          </div>
          <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Smart Properties ¬∑ Dashboard</h1>
          <p class="mt-2 text-white/80 font-bold text-xs uppercase tracking-[0.25em]">
            Manage Units ‚Ä¢ Sync Sheets & Drive
          </p>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <a id="btnGoIndex" class="btn bg-white/10 hover:bg-white/20 text-white" href="index.html">Public Index</a>
          <button id="btnLogout" class="btn bg-rose-500 hover:bg-rose-400 text-white">Logout</button>
        </div>
      </div>

      <!-- Controls -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-12 gap-3">
        <div class="md:col-span-4">
          <div class="text-[11px] font-extrabold text-white/70 uppercase tracking-widest mb-2">Search</div>
          <input id="q" class="w-full rounded-2xl px-4 py-3 bg-white/90 border border-white/60 outline-none font-bold text-slate-900"
                 placeholder="HP_ID / Plot / Project Name">
        </div>

        <div class="md:col-span-3">
          <div class="text-[11px] font-extrabold text-white/70 uppercase tracking-widest mb-2">System Status</div>
          <select id="sysFilter" class="w-full rounded-2xl px-4 py-3 bg-white/90 border border-white/60 outline-none font-extrabold text-slate-900">
            <option value="__all__">All</option>
            <option value="Live">Live</option>
            <option value="Pending">Pending</option>
            <option value="Offline">Offline</option>
          </select>
        </div>

        <div class="md:col-span-3">
          <div class="text-[11px] font-extrabold text-white/70 uppercase tracking-widest mb-2">Sort</div>
          <select id="sort" class="w-full rounded-2xl px-4 py-3 bg-white/90 border border-white/60 outline-none font-extrabold text-slate-900">
            <option value="hp_asc">HP_ID A‚ÜíZ</option>
            <option value="hp_desc">HP_ID Z‚ÜíA</option>
            <option value="price_desc">Price High‚ÜíLow</option>
            <option value="price_asc">Price Low‚ÜíHigh</option>
          </select>
        </div>

        <!-- Add new (UI ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô / ‡∏ñ‡πâ‡∏≤ GS ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö createUnit ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô) -->
        <div class="md:col-span-2">
          <div class="text-[11px] font-extrabold text-white/70 uppercase tracking-widest mb-2">New Unit</div>
          <button id="btnAdd" class="w-full btn bg-blue-600 hover:bg-blue-500 text-white">+ Add</button>
        </div>
      </div>
    </div>

    <!-- List -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4" id="list"></div>

    <div id="empty" class="hidden mt-6 card rounded-[2rem] p-8 text-center">
      <div class="text-2xl font-extrabold text-slate-900 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      <div class="text-slate-500 font-bold text-sm">‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö Search/Filter ‡πÉ‡∏´‡∏°‡πà</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /**********************************************************
     * CONFIG (Web App URL ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
     **********************************************************/
    const API_URL = "https://script.google.com/macros/s/AKfycbyTeJrl7A5D6nSjcxBsMAmfT0YcopmjMqI5YuXZ65FOXnWziWwe_j1FocdlaWWlQePR/exec";

    // pages
    const EDIT_URL    = "edit.html";
    const DETAILS_URL = "details.html";
    const INDEX_URL   = "index.html";

    // session
    const TOKEN   = (localStorage.getItem("HP_AUTH_TOKEN") || "").trim();
    const ROLE    = (localStorage.getItem("HP_AUTH_ROLE") || "").trim(); // "HQ" | "PROJECT"
    const PROJECT = (new URLSearchParams(location.search).get("project") || localStorage.getItem("HP_AUTH_PROJECT") || "HP00").trim();

    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.remove("show"), 2200);
    }

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function normSys(v){
      const s = String(v||"").trim();
      if(!s) return "";
      // normalize case
      const low = s.toLowerCase();
      if(low === "live") return "Live";
      if(low === "pending") return "Pending";
      if(low === "offline") return "Offline";
      return s;
    }

    function fmtPrice(v){
      const n = Number(String(v||"").replace(/,/g,""));
      if (!isFinite(n) || n<=0) return "‡∏ø0";
      return "‡∏ø" + n.toLocaleString("en-US");
    }

    function badgeStyleSys(sys){
      const s = normSys(sys);
      if (s === "Live")    return {bg:"rgba(192,255,222,.92)", fg:"rgba(0,90,55,1)"};
      if (s === "Pending") return {bg:"rgba(255,240,195,.92)", fg:"rgba(120,70,0,1)"};
      if (s === "Offline") return {bg:"rgba(255,208,208,.92)", fg:"rgba(130,0,0,1)"};
      return {bg:"rgba(255,255,255,.75)", fg:"rgba(15,23,42,.90)"};
    }

    function badgeStyleStatus(statusRaw){
      const s = String(statusRaw||"").trim().toLowerCase();
      if (s.includes("available")) return {bg:"rgba(192,255,222,.92)", fg:"rgba(0,90,55,1)"};
      if (s.includes("under"))     return {bg:"rgba(255,240,195,.92)", fg:"rgba(120,70,0,1)"};
      if (s.includes("reserved"))  return {bg:"rgba(213,232,255,.92)", fg:"rgba(0,60,120,1)"};
      if (s.includes("sold"))      return {bg:"rgba(255,208,208,.92)", fg:"rgba(130,0,0,1)"};
      return {bg:"rgba(255,255,255,.75)", fg:"rgba(15,23,42,.90)"};
    }

    // JSONP helper (‡∏Å‡∏±‡∏ô CORS ‡∏ö‡∏ô GitHub Pages)
    function jsonp_(paramsObj, timeoutMs = 15000){
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(16).slice(2);
        const urlParams = new URLSearchParams();
        Object.entries(paramsObj||{}).forEach(([k,v])=>{
          if(v===undefined || v===null) return;
          urlParams.set(k, String(v));
        });
        urlParams.set("callback", cbName);
        urlParams.set("t", Date.now());

        const script = document.createElement("script");
        let done = false;

        const timer = setTimeout(()=>{
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP timeout"));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
          if(script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (data)=>{
          if(done) return;
          done = true;
          cleanup();
          resolve(data);
        };

        script.onerror = ()=>{
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP network error"));
        };

        script.src = API_URL + "?" + urlParams.toString();
        document.body.appendChild(script);
      });
    }

    // fetch list (prefer JSONP; fallback fetch)
    async function getUnitList_(){
      try{
        return await jsonp_({ mode:"getUnitList", project: PROJECT, token: TOKEN });
      }catch(_){
        const url = new URL(API_URL);
        url.searchParams.set("mode","getUnitList");
        url.searchParams.set("project", PROJECT);
        if(TOKEN) url.searchParams.set("token", TOKEN);
        const res = await fetch(url.toString(), { cache:"no-store" });
        return await res.json();
      }
    }

    // state
    let all = [];
    let filtered = [];

    function mapListItem(x){
      return {
        id: x.id || x.hpId || x.HP_ID || "",
        plot: x.plot || x.Plot || "",
        projectName: x.projectName || x.Project_Name || x.project_name || "",
        address: x.address || x.Address || "",
        thumbnail: x.thumbnail || x.Thumbnail_Image || "",
        bedrooms: x.bedrooms || x.Bedrooms || "",
        bathrooms: x.bathrooms || x.Bathrooms || "",
        livingSqm: x.livingSqm || x.Living_Area_sq_m || x.living_area_sq_m || "",
        price: x.price || x.Price || "",
        status: x.status || x.Status || "",
        sysStatus: x.sysStatus || x.System_Status || x.system_status || ""
      };
    }

    function canEdit(item){
      const sys = normSys(item.sysStatus);
      if(ROLE === "HQ") return true;
      // PROJECT: Offline = view only
      if(sys === "Offline") return false;
      return true; // Pending/Live edit ‡πÑ‡∏î‡πâ
    }

    function applyFilters_(){
      const q = String($("q").value||"").trim().toLowerCase();
      const sysF = $("sysFilter").value;
      const sort = $("sort").value;

      filtered = all.slice();

      if(sysF !== "__all__"){
        filtered = filtered.filter(x => normSys(x.sysStatus) === sysF);
      }

      if(q){
        filtered = filtered.filter(x=>{
          const hay = [
            x.id, x.plot, x.projectName, x.address, x.status, x.sysStatus
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      filtered.sort((a,b)=>{
        const pa = Number(String(a.price||"").replace(/,/g,"")) || 0;
        const pb = Number(String(b.price||"").replace(/,/g,"")) || 0;

        if(sort === "price_asc") return pa - pb;
        if(sort === "price_desc") return pb - pa;

        // hp sort
        const ha = String(a.id||"");
        const hb = String(b.id||"");
        if(sort === "hp_desc") return hb.localeCompare(ha, "en");
        return ha.localeCompare(hb, "en");
      });

      render_();
    }

    function render_(){
      const box = $("list");
      box.innerHTML = "";

      $("empty").classList.toggle("hidden", filtered.length !== 0);

      filtered.forEach(item=>{
        const sys = normSys(item.sysStatus) || "-";
        const st  = String(item.status||"").trim() || "-";

        const sysSty = badgeStyleSys(sys);
        const stSty  = badgeStyleStatus(st);

        const editOk = canEdit(item);

        const editHref =
          `${EDIT_URL}?id=${encodeURIComponent(item.id)}&project=${encodeURIComponent(PROJECT)}&token=${encodeURIComponent(TOKEN)}`;

        const detailsHref =
          `${DETAILS_URL}?id=${encodeURIComponent(item.id)}&project=${encodeURIComponent(PROJECT)}${TOKEN ? `&token=${encodeURIComponent(TOKEN)}` : ""}`;

        const card = document.createElement("div");
        card.className = "card rounded-[2rem] overflow-hidden";

        card.innerHTML = `
          <div class="relative">
            <div class="h-44 bg-slate-100 overflow-hidden">
              ${item.thumbnail ? `<img src="${esc(item.thumbnail)}" class="w-full h-full object-cover" referrerpolicy="no-referrer">` : `<div class="w-full h-full grid place-items-center text-4xl">üñºÔ∏è</div>`}
            </div>

            <div class="absolute top-3 left-3 flex flex-col gap-2 max-w-[92%]">
              <div class="badge" style="background:${sysSty.bg}; color:${sysSty.fg};">
                üõ∞Ô∏è System: <span class="font-extrabold">${esc(sys)}</span>
              </div>
              <div class="badge" style="background:${stSty.bg}; color:${stSty.fg};">
                üìå Status: <span class="font-extrabold">${esc(st)}</span>
              </div>
            </div>

            <div class="absolute top-3 right-3">
              <div class="badge bg-white/80 text-slate-900">
                ${esc(item.id || "‚Äî")}
              </div>
            </div>
          </div>

          <div class="p-5">
            <div class="flex items-end justify-between gap-3">
              <div class="min-w-0">
                <div class="text-slate-500 font-extrabold text-[11px] uppercase tracking-widest">Plot</div>
                <div class="text-xl font-extrabold text-slate-900 truncate">${esc(item.plot || "-")}</div>
                <div class="text-slate-500 font-bold text-xs truncate mt-1">${esc(item.projectName || "")}</div>
              </div>
              <div class="text-right">
                <div class="text-slate-500 font-extrabold text-[11px] uppercase tracking-widest">Price</div>
                <div class="text-xl font-extrabold text-slate-900">${esc(fmtPrice(item.price))}</div>
              </div>
            </div>

            <div class="mt-3 grid grid-cols-3 gap-2">
              <div class="rounded-2xl bg-slate-50 border border-slate-100 p-3 text-center">
                <div class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">Beds</div>
                <div class="font-extrabold text-slate-900">${esc(item.bedrooms || "-")}</div>
              </div>
              <div class="rounded-2xl bg-slate-50 border border-slate-100 p-3 text-center">
                <div class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">Baths</div>
                <div class="font-extrabold text-slate-900">${esc(item.bathrooms || "-")}</div>
              </div>
              <div class="rounded-2xl bg-slate-50 border border-slate-100 p-3 text-center">
                <div class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">m¬≤</div>
                <div class="font-extrabold text-slate-900">${esc(item.livingSqm || "-")}</div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <a class="btn bg-slate-900 hover:bg-blue-600 text-white text-center"
                 href="${detailsHref}">View</a>

              ${
                editOk
                ? `<a class="btn bg-emerald-600 hover:bg-emerald-500 text-white text-center" href="${editHref}">Edit</a>`
                : `<button class="btn bg-slate-200 text-slate-500 cursor-not-allowed" disabled>Read Only</button>`
              }
            </div>
          </div>
        `;

        box.appendChild(card);
      });
    }

    async function load_(){
      // header chips
      $("chipRole").textContent = "ROLE: " + (ROLE || "-");
      $("chipProject").textContent = "PROJECT: " + (PROJECT || "-");
      $("btnGoIndex").href = `${INDEX_URL}?project=${encodeURIComponent(PROJECT)}`;

      if(!TOKEN){
        toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login (‡πÑ‡∏°‡πà‡∏°‡∏µ token)");
      }

      try{
        const raw = await getUnitList_();
        if(raw && raw.error) throw new Error(raw.error);
        if(!Array.isArray(raw)) throw new Error("API invalid (list not array)");

        all = raw.map(mapListItem);

        // HQ ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / PROJECT ‡∏Å‡πá‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏ï‡πà Offline edit ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        // ‡∏™‡πà‡∏ß‡∏ô ‚Äúpublic index‚Äù ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Live ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á index.html
        applyFilters_();
      }catch(e){
        console.error(e);
        toast("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        $("empty").classList.remove("hidden");
      }
    }

    // Add new unit (UI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô)
    async function addNew_(){
      if(ROLE !== "HQ"){
        return toast("Add ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HQ");
      }
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å mode=createUnit (‡∏ñ‡πâ‡∏≤ GS ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô error ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
      try{
        const out = await jsonp_({ mode:"createUnit", project: PROJECT, token: TOKEN });
        if(out && out.error) throw new Error(out.error);
        toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß");
        // ‡∏ñ‡πâ‡∏≤ GS ‡∏™‡πà‡∏á hpId ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ -> ‡πÄ‡∏õ‡∏¥‡∏î edit ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const newId = (out && (out.hpId || out.id || out.HP_ID)) ? String(out.hpId || out.id || out.HP_ID) : "";
        if(newId){
          location.href = `${EDIT_URL}?id=${encodeURIComponent(newId)}&project=${encodeURIComponent(PROJECT)}&token=${encodeURIComponent(TOKEN)}`;
          return;
        }
        await load_();
      }catch(e){
        toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°: createUnit (‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏•‡πà‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)");
        console.warn(e);
      }
    }

    function logout_(){
      localStorage.removeItem("HP_AUTH_TOKEN");
      localStorage.removeItem("HP_AUTH_ROLE");
      localStorage.removeItem("HP_AUTH_PROJECT");
      localStorage.removeItem("HP_AUTH_EXPIRES");
      toast("Logged out");
      setTimeout(()=>location.href="gateway.html?project="+encodeURIComponent(PROJECT), 450);
    }

    // init
    (function(){
      $("q").addEventListener("input", applyFilters_);
      $("sysFilter").addEventListener("change", applyFilters_);
      $("sort").addEventListener("change", applyFilters_);
      $("btnLogout").addEventListener("click", logout_);
      $("btnAdd").addEventListener("click", addNew_);
      load_();
    })();
  </script>
</body>
</html>
