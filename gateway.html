<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DIRECT ADMIN ¬∑ gateway</title>
  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b1a33;
      --card:#ffffff;
      --text:#0b1320;
      --muted:#6b7a90;
      --shadow:0 22px 70px rgba(0,0,0,.35);
      --radius:28px;
      --line:rgba(15,23,42,.08);
      --btn:#0b1320;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      min-height:100vh;
      display:grid;
      place-items:center;
      background:
        radial-gradient(1200px 700px at 50% 10%, rgba(255,255,255,.10), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#fff;
      padding:18px 14px;
    }
    .panel{
      width:min(520px, 94vw);
      background:rgba(255,255,255,.96);
      border:1px solid rgba(255,255,255,.45);
      border-radius: 46px;
      box-shadow: var(--shadow);
      padding:28px 22px 18px;
      position:relative;
      overflow:hidden;
    }
    .iconTop{
      width:74px;height:74px;border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.65));
      border:1px solid rgba(15,23,42,.08);
      box-shadow: 0 18px 40px rgba(0,0,0,.10);
      display:grid;place-items:center;
      margin: 4px auto 16px;
      color:#0b1320;
      font-size:30px;
    }
    .title{
      text-align:center;
      font-weight:1100;
      letter-spacing:.6px;
      font-size:30px;
      margin:0;
      color:#111827;
    }
    .sub{
      text-align:center;
      margin:8px 0 18px;
      color: rgba(17,24,39,.55);
      font-weight:800;
      font-size:12px;
      letter-spacing:.35em;
      text-transform:uppercase;
      line-height:1.45;
    }
    .box{
      background: rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.06);
      border-radius: 22px;
      padding:14px 14px 12px;
      width:min(420px, 92%);
      margin:0 auto;
    }
    label{
      display:block;
      font-weight:1000;
      color: rgba(15,23,42,.55);
      letter-spacing:.18em;
      font-size:11px;
      text-transform:uppercase;
      margin:8px 2px 8px;
      text-align:center;
    }
    input{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.12);
      outline:none;
      background: rgba(255,255,255,.9);
      font-size:16px;
      font-weight:900;
      text-align:center;
      color:#111827;
    }
    input:focus{ border-color: rgba(59,130,246,.55); box-shadow: 0 0 0 4px rgba(59,130,246,.15); }
    .err{
      margin-top:10px;
      text-align:center;
      font-weight:1000;
      color:#e11d48;
      font-size:12px;
      display:none;
    }
    .btn{
      width:min(420px, 92%);
      margin:16px auto 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:16px 16px;
      border-radius: 999px;
      border:0;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(11,19,32,1), rgba(11,19,32,.92));
      color:#fff;
      font-weight:1100;
      letter-spacing:.14em;
      text-transform:uppercase;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .hint{
      text-align:center;
      color: rgba(17,24,39,.40);
      font-weight:900;
      font-size:11px;
      letter-spacing:.22em;
      margin:10px 0 0;
      text-transform:uppercase;
    }
    .mini{
      margin-top:8px;
      text-align:center;
      color: rgba(17,24,39,.55);
      font-weight:900;
      font-size:12px;
    }
    .rowMini{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,.05);
      border:1px solid rgba(15,23,42,.06);
      color: rgba(15,23,42,.70);
      font-weight:1000;
      font-size:12px;
      max-width: 92%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .loading{
      pointer-events:none;
      opacity:.7;
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="iconTop" aria-hidden="true">üîê</div>
    <h1 class="title">DIRECT ADMIN</h1>
    <div class="sub">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô<br/>
      AUTHORIZED PERSONNEL ONLY
    </div>

    <div class="box">
      <label>PROJECT</label>
      <input id="projectInput" type="text" inputmode="text" autocomplete="off" />

      <label style="margin-top:12px;">PIN</label>
      <input id="pinInput" type="password" inputmode="numeric" autocomplete="one-time-code" maxlength="12" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

      <div class="err" id="errBox">-</div>
    </div>

    <button class="btn" id="loginBtn" type="button">
      <span>LOGIN TO DASHBOARD</span>
      <span aria-hidden="true">‚Üí</span>
    </button>

    <div class="rowMini">
      <div class="chip" id="chipProject">project: -</div>
      <div class="chip" id="chipBack">back: -</div>
    </div>

    <div class="hint">SESSION EXPIRES AUTOMATICALLY</div>
    <div class="mini" id="miniNote"></div>
  </div>

<script>
/** =========================
 * CONFIG (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
 * ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwxlsoGQV_IF_UOcQTpAiUajl9bIK8h4B1irTklEvmpiTPhiDPi7vnU-E3xm9pr3acN/exec";
const LS_TOKEN_KEY = "HP_AUTH_TOKEN";

/** =========================
 * URL / Alias / Back
 * ========================= */
const qs = new URLSearchParams(location.search);
let projectRaw = (qs.get("project") || "").trim();

// ‚úÖ Alias map: ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö ‚Üí ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï
const PROJECT_ALIAS = {
  "Properties": "HP00",
  "properties": "HP00",
  "MASTER": "HP00",
  "Master": "HP00",
  "HP00": "HP00",
};

let project = PROJECT_ALIAS[projectRaw] || projectRaw || "HP00";

// back url
let back = (qs.get("back") || "").trim();
try{ back = back ? decodeURIComponent(back) : ""; }catch(e){}

/** UI refs */
const projectInput = document.getElementById("projectInput");
const pinInput = document.getElementById("pinInput");
const errBox = document.getElementById("errBox");
const loginBtn = document.getElementById("loginBtn");
const chipProject = document.getElementById("chipProject");
const chipBack = document.getElementById("chipBack");
const miniNote = document.getElementById("miniNote");

// ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô UI
projectInput.value = projectRaw || project;
chipProject.textContent = "project: " + (projectRaw || project);
chipBack.textContent = "back: " + (back ? back : "-");

if(projectRaw && PROJECT_ALIAS[projectRaw]){
  miniNote.textContent = `Alias: ${projectRaw} ‚Üí ${PROJECT_ALIAS[projectRaw]}`;
}else{
  miniNote.textContent = "";
}

/** =========================
 * Helpers
 * ========================= */
function setError(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
}
function clearError(){
  errBox.style.display = "none";
  errBox.textContent = "";
}
function setLoading(on){
  if(on){
    loginBtn.classList.add("loading");
    loginBtn.textContent = "LOGGING IN...";
  }else{
    loginBtn.classList.remove("loading");
    loginBtn.innerHTML = `<span>LOGIN TO DASHBOARD</span><span aria-hidden="true">‚Üí</span>`;
  }
}

/** JSONP (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GitHub Pages) */
function jsonp(url, timeoutMs = 20000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      if (script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
    }

    window[cb] = (data) => { cleanup(); resolve(data); };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + encodeURIComponent(cb) + "&t=" + Date.now();
    script.onerror = () => { cleanup(); reject(new Error("jsonp_error")); };
    document.body.appendChild(script);
  });
}

/** redirect after login */
function goAfterLogin(token){
  try{ localStorage.setItem(LS_TOKEN_KEY, token); }catch(e){}

  if(back){
    try{
      const u = new URL(back, location.origin);
      u.searchParams.set("project", project);
      u.searchParams.set("token", token);
      location.href = u.toString();
      return;
    }catch(e){
      const join = back.startsWith("/") ? back : ("/" + back);
      location.href = join + (join.includes("?") ? "&" : "?") +
        "project=" + encodeURIComponent(project) + "&token=" + encodeURIComponent(token);
      return;
    }
  }

  location.href = `dashboard.html?project=${encodeURIComponent(project)}&token=${encodeURIComponent(token)}`;
}

/** =========================
 * Login via GS (‡∏•‡∏≠‡∏á project ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
 * ========================= */
async function doLogin(){
  clearError();
  setLoading(true);

  const projectTyped = (projectInput.value || "").trim();
  const pin = (pinInput.value || "").trim();

  if(!pin){
    setLoading(false);
    setError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà PIN");
    pinInput.focus();
    return;
  }

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á candidates ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ ‚ÄúProject not configured for login‚Äù
  const candidates = [];
  const add = (v)=>{ v=(v||"").trim(); if(v && !candidates.includes(v)) candidates.push(v); };

  // 1) ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏°‡∏≤‡∏Å‡∏±‡∏ö URL
  add(projectTyped);
  add(projectRaw);

  // 2) alias ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏°‡∏≤‡∏Å‡∏±‡∏ö URL
  add(PROJECT_ALIAS[projectTyped]);
  add(PROJECT_ALIAS[projectRaw]);

  // 3) ‡∏Ñ‡πà‡∏≤ fallback ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
  add(project);
  add("HP00");
  add("Properties");

  // 4) ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ case ‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå
  add((projectTyped||"").toLowerCase());
  add((projectTyped||"").toUpperCase());
  add((projectRaw||"").toLowerCase());
  add((projectRaw||"").toUpperCase());

  let lastErr = "";

  try{
    for(const projTry of candidates){
      const url =
        `${SCRIPT_URL}?mode=login` +
        `&project=${encodeURIComponent(projTry)}` +
        `&pin=${encodeURIComponent(pin)}`;

      const res = await jsonp(url, 20000);

      const ok = !!(res && (res.ok === true || res.success === true || res.status === "ok"));
      const token = (res && (res.token || res.authToken || res.access_token))
        ? String(res.token || res.authToken || res.access_token)
        : "";
      const err = res && (res.error || res.message) ? String(res.error || res.message) : "";

      if(ok && token){
        // ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏î‡πâ‡∏ß‡∏¢ project ‡∏ô‡∏µ‡πâ
        project = projTry;
        chipProject.textContent = "project: " + project;
        setLoading(false);
        goAfterLogin(token);
        return;
      }

      lastErr = err || "Login failed";

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô PIN ‡∏ú‡∏¥‡∏î ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏≠‡∏á‡∏ï‡πà‡∏≠
      const eLow = (lastErr || "").toLowerCase();
      const isPinErr =
        eLow.includes("pin") ||
        eLow.includes("invalid") ||
        eLow.includes("not authorized") ||
        eLow.includes("unauthorized");

      if(isPinErr){
        break;
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ project ‚Üí ‡∏•‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ candidate ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    }

    setLoading(false);
    setError(lastErr || "Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    pinInput.focus();
    pinInput.select?.();

  }catch(e){
    setLoading(false);
    setError("Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à Deploy Apps Script ‡πÄ‡∏õ‡πá‡∏ô /exec ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Anyone / JSONP)");
  }
}

/** events */
loginBtn.addEventListener("click", doLogin);
pinInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") doLogin(); });
projectInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") pinInput.focus(); });

// ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ PIN ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
setTimeout(()=> pinInput.focus(), 50);
</script>
</body>
</html>
